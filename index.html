<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ultimate Comic Storyboard — AI Edition</title>
  <style>
    :root{--bg:#0f1724;--panel:#0b1220;--accent:#06b6d4;--ui:#e6eef6}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ui);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-columns:320px 1fr 320px;grid-template-rows:56px 1fr;gap:12px;height:100vh;padding:12px;box-sizing:border-box}
    header{grid-column:1/4;display:flex;align-items:center;gap:12px;padding:8px 12px;background:#071526;border-radius:8px}
    header h1{font-size:16px;margin:0}
    .sidebar, .rightbar{background:#071826;border-radius:8px;padding:12px;overflow:auto}
    .toolbar{display:flex;flex-direction:column;gap:8px}
    .tool{display:flex;gap:8px;align-items:center}
    button,select,input[type=range],input[type=text]{appearance:none}
    button{background:#0b2a3a;border:1px solid rgba(255,255,255,0.04);color:var(--ui);padding:8px 10px;border-radius:6px;cursor:pointer}
    button.active{outline:2px solid rgba(6,182,212,0.14);box-shadow:0 6px 16px rgba(2,6,23,0.6)}
    .canvas-wrap{background:linear-gradient(180deg,#031022 0%, #041426 100%);border-radius:8px;padding:12px;display:flex;flex-direction:column}
    #stage{border-radius:6px;background:#fff;flex:1;display:flex;align-items:center;justify-content:center}
    .stage-inner{position:relative}
    canvas{background:white;border:1px solid #ccc}
    label{font-size:13px;color:#9fb6c7}
    .row{display:flex;gap:8px;align-items:center}
    .templates{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
    .template{background:#071826;border:1px dashed #0b2633;padding:8px;border-radius:6px;text-align:center;cursor:pointer}
    footer.actions{display:flex;gap:8px}
    .rightbar h3{margin-top:0}
    .panel-list{display:flex;flex-direction:column;gap:6px}
    .panel-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:#051323}
    .help{font-size:13px;opacity:0.9}
    .muted{opacity:0.7;font-size:13px}
    input[type=color]{width:44px;height:34px;padding:0;border:none;background:transparent}
    input[type=text]{flex:1;padding:6px;border-radius:4px;border:1px solid #0b2a3a;background:#0b2a3a;color:var(--ui)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Ultimate Comic Storyboard — AI Edition</h1>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="downloadAll">Download PNG</button>
        <button id="exportProject">Export .json</button>
        <button id="importProjectBtn">Import .json</button>
        <input id="importFile" type="file" accept="application/json,image/*" style="display:none" />
      </div>
    </header>

    <aside class="sidebar">
      <div class="toolbar">
        <div class="tool">
          <button data-tool="brush" class="active">Brush</button>
          <button data-tool="eraser">Eraser</button>
          <button data-tool="fill">Fill</button>
          <button data-tool="panel">Panel Cutter</button>
        </div>

        <div class="tool">
          <label class="muted">Size</label>
          <input id="size" type="range" min="1" max="120" value="8">
        </div>

        <div class="tool">
          <label class="muted">Color</label>
          <input id="color" type="color" value="#000000">
        </div>

        <div class="tool">
          <button id="undo">Undo</button>
          <button id="redo">Redo</button>
          <button id="clear">Clear</button>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,0.03);padding-top:8px">
          <label class="muted">AI Generators</label>
          <div class="tool" style="flex-direction:column;gap:4px">
            <input type="text" id="aiPrompt" placeholder="Enter prompt for pose or lineart" />
            <input type="text" id="apiKey" placeholder="Paste HuggingFace API Key here" />
            <div style="display:flex;gap:4px">
              <button id="generatePose">Generate Pose</button>
              <button id="generateLineart">Generate Lineart</button>
            </div>
          </div>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,0.03);padding-top:8px">
          <label class="muted">Templates</label>
          <div class="templates">
            <div class="template" data-temp="1">1 Panel</div>
            <div class="template" data-temp="2">2 Vertical</div>
            <div class="template" data-temp="3">3 Vertical</div>
            <div class="template" data-temp="grid2">2x2 Grid</div>
          </div>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,0.03);padding-top:8px">
          <label class="muted">Quick tips</label>
          <div class="help">Use the Panel Cutter tool to draw rectangular panels. Use AI buttons to generate poses or lineart. Export PNG when done.</div>
        </div>
      </div>
    </aside>

    <main class="canvas-wrap">
      <div id="stage">
        <div class="stage-inner">
          <canvas id="canvas" width="1400" height="900"></canvas>
          <svg id="overlay" width="1400" height="900" style="position:absolute;left:0;top:0;pointer-events:none"></svg>
        </div>
      </div>
    </main>

    <aside class="rightbar">
      <h3>Panels</h3>
      <div class="panel-list" id="panelList"></div>
      <div style="height:12px"></div>
      <h3>AI Assets</h3>
      <div id="assets"></div>
      <div style="height:12px"></div>
      <h3>Export Options</h3>
      <div class="row"><button id="exportPanelPNGs">Export Panels as PNGs</button></div>
    </aside>
  </div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let drawing=false;
let tool='brush';
let color='#000000';
let size=8;
let history=[];let future=[];
let panels=[];
ctx.fillStyle='white';
ctx.fillRect(0,0,canvas.width,canvas.height);
pushHistory();

function pushHistory(){try{history.push(canvas.toDataURL());if(history.length>50)history.shift();future=[];}catch(e){}}

// Continuous Brush/Eraser
canvas.addEventListener('mousedown',e=>{if(tool==='brush'||tool==='eraser'){drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);}});
canvas.addEventListener('mousemove',e=>{if(!drawing)return;if(tool==='brush'){ctx.globalCompositeOperation='source-over';ctx.strokeStyle=color;ctx.lineWidth=size;ctx.lineCap='round';ctx.lineJoin='round';ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}else if(tool==='eraser'){ctx.globalCompositeOperation='destination-out';ctx.lineWidth=size;ctx.lineCap='round';ctx.lineJoin='round';ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();ctx.globalCompositeOperation='source-over';}});
canvas.addEventListener('mouseup',()=>{if(drawing){drawing=false;pushHistory();ctx.beginPath();}});
canvas.addEventListener('mouseleave',()=>{if(drawing){drawing=false;pushHistory();ctx.beginPath();}});

// Fill tool
canvas.addEventListener('click',e=>{if(tool==='fill'){floodFill(e.offsetX,e.offsetY,color);}});
function floodFill(x,y,fillColor){const w=canvas.width,h=canvas.height;const img=ctx.getImageData(0,0,w,h);const data=img.data;const idx=(y*w+x)*4;const target=[data[idx],data[idx+1],data[idx+2],data[idx+3]];const newC=hexToRgba(fillColor);if(JSON.stringify(target)===JSON.stringify(newC))return;const stack=[[x,y]];while(stack.length){const[cx,cy]=stack.pop();if(cx<0||cy<0||cx>=w||cy>=h)continue;const i=(cy*w+cx)*4;if(equalPixel(data,i,target)){data[i]=newC[0];data[i+1]=newC[1];data[i+2]=newC[2];data[i+3]=newC[3];stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);}}ctx.putImageData(img,0,0);pushHistory();}
function equalPixel(data,i,target){return data[i]===target[0]&&data[i+1]===target[1]&&data[i+2]===target[2]&&data[i+3]===target[3];}
function hexToRgba(hex){const h=hex.replace('#','');const bigint=parseInt(h,16);if(h.length===6)return[(bigint>>16)&255,(bigint>>8)&255,bigint&255,255];return[0,0,0,255];}

// Tool selection
document.querySelectorAll('button[data-tool]').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('button[data-tool]').forEach(x=>x.classList.remove('active'));b.classList.add('active');tool=b.dataset.tool;}));
document.getElementById('color').addEventListener('input',e=>color=e.target.value);
document.getElementById('size').addEventListener('input',e=>size=e.target.value);

// Undo/Redo
document.getElementById('undo').addEventListener('click',async()=>{if(history.length<=1)return;future.push(history.pop());const last=history[history.length-1];await restoreFromDataURL(last);});
document.getElementById('redo').addEventListener('click',async()=>{if(!future.length)return;const f=future.pop();await restoreFromDataURL(f);history.push(f);});
function restoreFromDataURL(d){return new Promise(res=>{const img=new Image();img.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0);res();};img.src=d;});}

// Clear
document.getElementById('clear').addEventListener('click',()=>{ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='white';ctx.fillRect(0,0,canvas.width,canvas.height);pushHistory();});

// Export
document.getElementById('downloadAll').addEventListener('click',()=>{const a=document.createElement('a');a.href=canvas.toDataURL();a.download='storyboard.png';a.click();});
document.getElementById('exportPanelPNGs').addEventListener('click',()=>{if(!panels.length)return alert('No panels');panels.forEach((p,i)=>{const tmp=document.createElement('canvas');tmp.width=p.w;tmp.height=p.h;tmp.getContext('2d').drawImage(canvas,p.x,p.y,p.w,p.h,0,0,p.w,p.h);const a=document.createElement('a');a.href=tmp.toDataURL();a.download=`panel-${i+1}.png`;a.click();});});

// AI Image Generation (Hugging Face SDXL)
async function generateAI(type){
  const prompt = document.getElementById('aiPrompt').value || type;
  const key = document.getElementById('apiKey').value.trim();
  if(!key){addAIAsset(type + ' [placeholder]'); return;}
  try{
    addAIAsset(type + ' [generating...]');
    const res = await fetch('https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0',{method:'POST',headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},body:JSON.stringify({inputs:prompt})});
    const blob = await res.blob();
    const imgURL = URL.createObjectURL(blob);
    const img = new Image(); img.onload=()=>{ctx.drawImage(img,0,0,canvas.width,canvas.height); URL.revokeObjectURL(imgURL);}; img.src = imgURL;
    addAIAsset(type);
  }catch(e){console.error(e);addAIAsset(type+' [error]');}
}
function addAIAsset(type){const el=document.getElementById('assets');const d=document.createElement('div');d.style.margin='6px 0';d.style.padding='6px';d.style.background='#051520';d.style.borderRadius='6px';d.innerText=`[AI ${type} generated here]`;el.appendChild(d);}

document.getElementById('generatePose').addEventListener('click',()=>generateAI('Pose'));
document.getElementById('generateLineart').addEventListener('click',()=>generateAI('Lineart'));
</script>
</body>
</html>
